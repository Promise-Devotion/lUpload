/**
 * Author : dsphper
 * Email : dsphper@gmail.com
 * Version : 0.0.1
 * Licensed under the MIT license:
 * 	http://www.opensource.org/licenses/mit-license.php
 * 	Project home:
 * 	https://github.com/dsphper/lUpload
 */
!function(a){function l(a){a.dataTransfer.dropEffect="copy",a.preventDefault(),a.stopPropagation()}function m(a){a.dataTransfer.dropEffect="copy",a.preventDefault(),a.stopPropagation()}function n(a){a.dataTransfer.dropEffect="copy",a.preventDefault(),a.stopPropagation()}function p(a){D(a.dataTransfer.files),a.dataTransfer.dropEffect="copy",a.preventDefault(),a.stopPropagation()}function q(a){b.dropDefa(a),a.dataTransfer.dropEffect="none",a.preventDefault(),a.stopPropagation()}function r(a){b.enterDefa(a),a.dataTransfer.dropEffect="none",a.preventDefault(),a.stopPropagation()}function s(a){b.leaveDefa(a),a.dataTransfer.dropEffect="none",a.preventDefault(),a.stopPropagation()}function t(a){b.overDefa(a),a.dataTransfer.dropEffect="none",a.preventDefault(),a.stopPropagation()}function u(c,d){var e,f,g,h,i;if(c.lengthComputable){if(e=(new Date).getTime(),f=c.loaded/1024,g=(e-j)/1e3,k.push((f/g).toFixed(2)),100==100*(c.loaded/c.total))for(h=0,i=0;i<k.length;i++)h+=parseInt(k[i]);b.run(a("#uList li").eq(d.index),Math.round(100*(c.loaded/c.total)),(f/g).toFixed(2))}else alert("无法获得文件大小")}function v(a){var b=a.size;return b>=1073741824?b=Math.round(100*(b/1073741824))/100+" GB":b>=1048576?b=Math.round(100*(b/1048576))/100+" MB":b>=1024?b=Math.round(100*(b/1024))/100+" KB":b+=" Bytes",b}function w(c,d,e){var g,f=b.tpl();a("#uList").html(a("#uList").html()+f),g=a("#uList li").eq(c.index),g.find(".borderImg img").attr("src",d.target.result),g.find(".fileName").text(c.name),g.find(".fileSize").text(e.width+" X "+e.height),g.find(".size").text(v(c)),C(c)}function x(a,b){var c=new Image;c.src=b.target.result,c.addEventListener("load",function(){w(a,b,c)},!1)}function y(a){var b=new FileReader;b.addEventListener("load",function(b){B(a,b)},!1),b.readAsDataURL(a)}function z(a){var f,h,c=a.type?a.type.split("/")[1]:"other";if(c&&(f=!1,b.type.length>0)){for(o in b.type)if(c==b.type[o]){f=!0;break}if(!f)return b.error(d[3]),e["200"]}return g>b.maxfiles?(b.error(d[1]),e["201"]):(h=1048576*b.maxfilesize,a.size>h?(b.error(d[2]),e["200"]):void 0)}function A(){var a,b,c;if(window.XMLHttpRequest)return new XMLHttpRequest;for(a=["msxml","msxml2","msxml3","Microsoft"],b=0;b<a.length;b++)try{return c=a[b]+".XMLHTTP",new ActiveXObject(c)}catch(d){}return null}function B(a,b){var c=a.type?a.type.split("/")[1]:"other";return"jpeg"==c||"png"==c||"gif"==c||"bmp"==c||"x-icon"==c?(x(a,b),void 0):(alert("other"),void 0)}function C(a){var d,e,c=A();c.open("POST",b.url,!0),d=c.upload,d&&d.addEventListener("progress",function(b){u(b,a)},!1),c.addEventListener("readystatechange",function(){4==c.readyState&&200==c.status&&b.complete(a)},!1),e=new FormData,e.append("FileData",a),c.send(e),j=(new Date).getTime()}function D(a){var b,c;for(a=E(a),g=a.length,b=0;b<a.length;b++){if(c=z(a[b]),"deadly"==c)return!1;"warning"!=c&&(a[b].index=h++,y(a[b]),i=a[b])}}function E(a){var c,d,e,b=[];for(c=0;c<a.length;c++)b[c]=a[c];for(c=0;c<b.length;c++)for(d=c+1;d<b.length;d++)b[d].size<b[c].size&&(e=b[d],b[d]=b[c],b[c]=e);return b}var b={},c={url:"",maxfiles:2,maxfilesize:2,run:function(){},error:function(a){alert(a)},multithreading:!0,type:[],dragenter:function(){return!1},dragleave:function(){return!1},dragover:function(){return!1},drop:function(){return!1},dropDefa:function(){return!1},enterDefa:function(){return!1},leaveDefa:function(){return!1},overDefa:function(){return!1},tpl:function(){return"false"},setImageTpl:function(){},complete:function(){},Knowntype:{pdf:"./image/pdf.jpg",html:"./image/html.png"}},d=["浏览器不支持","超过最大文件数","文件大小超过限制","不允许的上传格式"],e={200:"warning",201:"deadly"},g=0,h=0,i=0,j=0,k=[];a.fn.dropFile=function(d){a.event.props.push("dataTransfer"),b=a.extend({},c,d),this.bind("dragenter",l).bind("dragleave",m).bind("dragover",n).bind("drop",p),a(document).bind("drop",q).bind("dragover",t).bind("dragleave",s).bind("dragenter",r)}}(jQuery);